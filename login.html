<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Login to your Clippit account - Customer, Investor, or Admin access.">
    <title>Login - Clippit</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container nav-container">
            <a href="index.html" class="logo">
                <img src="images/logo2.png" alt="Clippit Logo" class="logo-icon" style="width: 40px; height: 40px; object-fit: contain;">
                <span class="logo-text">Clippit</span>
            </a>
            <a href="index.html" class="back-link">‚Üê Back to Home</a>
        </div>
    </nav>

    <!-- Login Selection -->
    <section class="login-selection-page">
        <div class="container">
            <div class="login-selection-container">
                <div class="login-header">
                    <div class="login-logo">
                        <img src="images/logo2.png" alt="Clippit Logo" class="logo-icon" style="width: 60px; height: 60px; object-fit: contain;">
                    </div>
                    <h1>Welcome!</h1>
                    <p class="login-subtitle">How would you like to access Clippit?</p>
                </div>

                <div class="login-options">
                    <div onclick="showLoginForm('customer')" class="login-option-card" style="cursor: pointer;">
                        <div class="option-icon customer">üë§</div>
                        <div class="option-content">
                            <h3>Customer Login</h3>
                            <p>Access your projects, track progress, and manage your account</p>
                        </div>
                        <div class="option-arrow">‚Üí</div>
                    </div>

                    <div onclick="showLoginForm('investor')" class="login-option-card" style="cursor: pointer;">
                        <div class="option-icon investor">üíº</div>
                        <div class="option-content">
                            <h3>Investor Login</h3>
                            <p>View portfolio companies and investment opportunities</p>
                        </div>
                        <div class="option-arrow">‚Üí</div>
                    </div>

                    <div onclick="showLoginForm('admin')" class="login-option-card" style="cursor: pointer;">
                        <div class="option-icon admin">‚öôÔ∏è</div>
                        <div class="option-content">
                            <h3>Admin Login</h3>
                            <p>Manage system settings and administrative functions</p>
                        </div>
                        <div class="option-arrow">‚Üí</div>
                    </div>
                </div>

                <!-- Login Form (Hidden by default) -->
                <div id="login-form-container" style="display: none; margin-top: 2rem;">
                    <button onclick="backToSelection()" style="margin-bottom: 1rem; padding: 0.5rem 1rem; background: transparent; color: #40E0D0; border: 1px solid #40E0D0; border-radius: 8px; cursor: pointer;">‚Üê Back to Selection</button>
                    
                    <div style="background: #1F2937; padding: 2rem; border-radius: 16px; border: 1px solid #374151;">
                        <div style="text-align: center; margin-bottom: 2rem;">
                            <div id="login-form-icon" style="font-size: 3rem; margin-bottom: 1rem;">üë§</div>
                            <h2 id="login-form-title" style="color: #40E0D0; font-size: 1.5rem; margin-bottom: 0.5rem;">Customer Login</h2>
                            <p style="color: #9CA3AF;">Enter your credentials to access your dashboard</p>
                        </div>

                        <form id="login-form" onsubmit="handleLogin(event)" style="display: flex; flex-direction: column; gap: 1.5rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; color: #fff; font-weight: 500;">Username / Email</label>
                                <input type="text" id="login-username" required style="width: 100%; padding: 0.75rem; background: #111827; border: 1px solid #4B5563; border-radius: 8px; color: #fff; font-size: 1rem;" placeholder="Enter your email address">
                            </div>

                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; color: #fff; font-weight: 500;">Password</label>
                                <input type="password" id="login-password" required style="width: 100%; padding: 0.75rem; background: #111827; border: 1px solid #4B5563; border-radius: 8px; color: #fff; font-size: 1rem;" placeholder="Enter your password">
                            </div>

                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; color: #9CA3AF; cursor: pointer;">
                                    <input type="checkbox" style="width: 18px; height: 18px;">
                                    <span>Remember me</span>
                                </label>
                                <a href="#" onclick="showForgotPassword(event)" style="color: #40E0D0; text-decoration: none;">Forgot password?</a>
                            </div>

                            <button type="submit" style="width: 100%; padding: 1rem; background: linear-gradient(135deg, #40E0D0, #36B8A8); color: #111827; border: none; border-radius: 50px; font-weight: 600; font-size: 1rem; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                Sign In
                            </button>
                        </form>

                        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #374151; text-align: center;">
                            <p style="color: #9CA3AF; font-size: 0.875rem;">Don't have an account? <a href="index.html#contact" style="color: #40E0D0; text-decoration: none;">Contact us</a></p>
                        </div>
                    </div>
                </div>

                <div class="login-footer">
                    <p>Don't have an account? <a href="index.html#contact">Contact us to get started</a></p>
                </div>
            </div>
        </div>
    </section>

    <!-- Forgot Password Modal -->
    <div id="forgot-password-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: #1F2937; padding: 2rem; border-radius: 16px; border: 1px solid #374151; max-width: 500px; width: 90%; position: relative;">
            <button onclick="closeForgotPassword()" style="position: absolute; top: 1rem; right: 1rem; background: transparent; border: none; color: #9CA3AF; font-size: 1.5rem; cursor: pointer; padding: 0.5rem;">√ó</button>
            
            <div style="text-align: center; margin-bottom: 2rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üîí</div>
                <h2 style="color: #40E0D0; font-size: 1.5rem; margin-bottom: 0.5rem;">Reset Password</h2>
                <p style="color: #9CA3AF;">Enter your email address and we'll send you a link to reset your password.</p>
            </div>

            <form id="forgot-password-form" onsubmit="handleForgotPassword(event)" style="display: flex; flex-direction: column; gap: 1.5rem;">
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: #fff; font-weight: 500;">Email Address</label>
                    <input type="email" id="reset-email" required style="width: 100%; padding: 0.75rem; background: #111827; border: 1px solid #4B5563; border-radius: 8px; color: #fff; font-size: 1rem;" placeholder="Enter your email address">
                </div>

                <button type="submit" style="width: 100%; padding: 1rem; background: linear-gradient(135deg, #40E0D0, #36B8A8); color: #111827; border: none; border-radius: 50px; font-weight: 600; font-size: 1rem; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    Send Reset Link
                </button>
            </form>

            <div id="reset-success-message" style="display: none; margin-top: 1rem; padding: 1rem; background: rgba(64, 224, 208, 0.1); border: 1px solid #40E0D0; border-radius: 8px; color: #40E0D0; text-align: center;">
                ‚úì Password reset link sent! Check your email.
            </div>
        </div>
    </div>

    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Supabase Configuration -->
    <script src="supabase-config.js"></script>
    
    <script src="script.js"></script>
    <script>
        // Clear any existing sessions when landing on login page
        async function clearSession() {
            await supabase.auth.signOut();
            sessionStorage.clear();
            localStorage.clear();
        }
        
        clearSession();

        // Handle login with Supabase
        async function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const loginType = window.currentLoginType || 'customer';
            
            // Get submit button reference outside try block
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            
            try {
                // Show loading state
                submitBtn.textContent = 'Signing in...';
                submitBtn.disabled = true;
                
                // Sign in with Supabase
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) throw error;
                
                // Get user profile to check role
                const profile = await getUserProfile(data.user.id);
                
                if (!profile) {
                    throw new Error('User profile not found');
                }
                
                // Verify the user's role matches the selected login type
                if (profile.role !== loginType && loginType !== 'admin') {
                    throw new Error(`This account is not registered as a ${loginType}. Please select the correct login type.`);
                }
                
                // For admin, check if they have admin role
                if (loginType === 'admin' && profile.role !== 'admin') {
                    throw new Error('You do not have admin privileges.');
                }
                
                // Store login info
                sessionStorage.setItem('isLoggedIn', 'true');
                sessionStorage.setItem('loginType', profile.role);
                sessionStorage.setItem('userId', data.user.id);
                sessionStorage.setItem('userEmail', data.user.email);
                
                // Redirect based on role
                switch(profile.role) {
                    case 'admin':
                        window.location.href = 'admin-dashboard.html';
                        break;
                    case 'customer':
                        window.location.href = 'customer-dashboard.html';
                        break;
                    case 'investor':
                        window.location.href = 'investor-dashboard.html';
                        break;
                    case 'team':
                        window.location.href = 'customer-dashboard.html'; // Team members use customer dashboard
                        break;
                    default:
                        window.location.href = 'index.html';
                }
                
            } catch (error) {
                console.error('Login error:', error);
                
                // Reset button
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                
                // Show error message
                let errorMessage = 'Login failed. Please check your credentials.';
                if (error.message.includes('Invalid login credentials')) {
                    errorMessage = 'Invalid email or password. Please try again.';
                } else if (error.message.includes('Email not confirmed')) {
                    errorMessage = 'Please verify your email before logging in.';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                alert(errorMessage);
            }
        }

        // Store current login type
        window.currentLoginType = 'customer';

        function showLoginForm(type) {
            window.currentLoginType = type;
            
            // Hide selection, show form
            document.querySelector('.login-options').style.display = 'none';
            document.querySelector('.login-footer').style.display = 'none';
            document.getElementById('login-form-container').style.display = 'block';
            
            // Update form UI based on type
            const icons = {
                customer: 'üë§',
                investor: 'üíº',
                admin: '‚öôÔ∏è'
            };
            
            const titles = {
                customer: 'Customer Login',
                investor: 'Investor Login',
                admin: 'Admin Login'
            };
            
            document.getElementById('login-form-icon').textContent = icons[type];
            document.getElementById('login-form-title').textContent = titles[type];
        }

        function backToSelection() {
            document.querySelector('.login-options').style.display = 'flex';
            document.querySelector('.login-footer').style.display = 'block';
            document.getElementById('login-form-container').style.display = 'none';
            document.getElementById('login-form').reset();
        }

        // Forgot Password Functions
        function showForgotPassword(event) {
            event.preventDefault();
            const modal = document.getElementById('forgot-password-modal');
            modal.style.display = 'flex';
            document.getElementById('reset-success-message').style.display = 'none';
            document.getElementById('forgot-password-form').reset();
        }

        function closeForgotPassword() {
            const modal = document.getElementById('forgot-password-modal');
            modal.style.display = 'none';
            document.getElementById('forgot-password-form').reset();
            document.getElementById('reset-success-message').style.display = 'none';
        }

        async function handleForgotPassword(event) {
            event.preventDefault();
            
            const email = document.getElementById('reset-email').value;
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            
            try {
                // Show loading state
                submitBtn.textContent = 'Sending...';
                submitBtn.disabled = true;
                
                // Send password reset email using Supabase
                const { error } = await supabase.auth.resetPasswordForEmail(email, {
                    redirectTo: `${window.location.origin}/reset-password.html`
                });
                
                if (error) throw error;
                
                // Show success message
                document.getElementById('reset-success-message').style.display = 'block';
                document.getElementById('forgot-password-form').style.display = 'none';
                
                // Auto-close after 3 seconds
                setTimeout(() => {
                    closeForgotPassword();
                    document.getElementById('forgot-password-form').style.display = 'flex';
                }, 3000);
                
            } catch (error) {
                console.error('Password reset error:', error);
                
                // Reset button
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                
                // Show error message
                alert(error.message || 'Failed to send reset email. Please try again.');
            }
        }

        // Close modal when clicking outside
        document.getElementById('forgot-password-modal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeForgotPassword();
            }
        });
    </script>
</body>
</html>
